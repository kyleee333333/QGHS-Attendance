<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>QR Code Student Attendance System</title>

    <!-- QR generation library (qrcodejs) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- QR scanner library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

    <!-- XLSX for export/import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* ===========================
           Styles copied from your original
           (kept layout & maroon theme)
           =========================== */

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; }
        .container { max-width:1200px; margin:0 auto; background:white; border-radius:15px; box-shadow:0 20px 40px rgba(0,0,0,0.08); overflow:hidden; }
        .header { background: linear-gradient(135deg,#8e1919,#8e1919); color:white; padding:30px; text-align:center; }
        .header h1 { font-size:2.5em; margin-bottom:6px; text-shadow:2px 2px 4px rgba(0,0,0,0.25); }
        .header h2 { margin-bottom:6px; font-weight:600; }
        .nav-tabs { display:flex; background:#f8f9fa; border-bottom:2px solid #ddd; }
        .nav-tab { flex:1; padding:15px 20px; background:transparent; border:none; cursor:pointer; font-size:16px; font-weight:500; color:#666; transition:all .3s; border-bottom:3px solid transparent; }
        .nav-tab.active { background:white; color:#8e1919; border-bottom-color:#851d1d; }
        .nav-tab:hover { background:#e9ecef; color:#333; }
        .tab-content { display:none; padding:30px; animation:fadeIn .25s ease-in; }
        .tab-content.active { display:block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }

        .form-row { display:flex; gap:15px; margin-bottom:20px; }
        .form-row .form-group { flex:1; }
        label { display:block; margin-bottom:8px; font-weight:600; color:#333; }
        input, select { width:100%; padding:12px 15px; border:2px solid #ddd; border-radius:8px; font-size:16px; transition:border-color .2s; }
        input:focus, select:focus { outline:none; border-color:#7f2222; box-shadow:0 0 0 3px rgba(127,34,34,0.08); }

        .btn { background:linear-gradient(135deg,#af4c4c,#a04545); color:white; border:none; padding:12px 25px; border-radius:8px; cursor:pointer; font-size:16px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
        .btn:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(159,31,31,0.2); }
        .btn-secondary { background:linear-gradient(135deg,#6c757d,#5a6268); }
        .btn-danger { background:linear-gradient(135deg,#dc3545,#c82333); }

        .student-list { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; margin-top:20px; }
        .student-card { background:white; border:2px solid #e9ecef; border-radius:12px; padding:20px; box-shadow:0 4px 6px rgba(0,0,0,0.06); transition:all .25s; display:flex; gap:15px; align-items:center; }
        .student-card:hover { transform:translateY(-6px); box-shadow:0 8px 25px rgba(0,0,0,0.1); border-color:#af4c4c; }
        .student-info h3 { color:#333; margin-bottom:6px; }
        .student-info p { color:#666; margin-bottom:4px; font-size:14px;}
        .qr-code-container { width:150px; text-align:center; }

        .scanner-container { max-width:600px; margin: 0 auto; text-align:center; }
        #qr-reader { border:3px dashed #af4c4c; border-radius:12px; overflow:hidden; margin:12px 0; }

        .attendance-table { width:100%; border-collapse:collapse; margin-top:20px; background:white; border-radius:8px; overflow:hidden; box-shadow:0 4px 6px rgba(0,0,0,0.06); }
        .attendance-table th, .attendance-table td { padding:12px 15px; text-align:left; border-bottom:1px solid #eee; }
        .attendance-table th { background:#af4c4c; color:white; font-weight:600; }
        .attendance-table tr:hover { background:#f8f9fa; }
        .status-present { color:#1a7f1a; font-weight:bold; }
        .status-absent { color:#dc3545; font-weight:bold; }

        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:30px; }
        .stat-card { background:linear-gradient(135deg,#667eea,#764ba2); color:white; padding:25px; border-radius:12px; text-align:center; box-shadow:0 4px 15px rgba(102,126,234,0.2); }
        .stat-number { font-size:2.5em; font-weight:bold; margin-bottom:10px; }
        .stat-label { font-size:1.1em; opacity:0.95; }

        .success-message, .error-message { padding:15px; border-radius:8px; margin:15px 0; font-weight:500; }
        .success-message { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
        .error-message { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }

        .date-filter { display:flex; gap:15px; align-items: end; margin-bottom:20px; flex-wrap:wrap; }

        @media (max-width:768px) {
            .form-row { flex-direction:column; }
            .nav-tabs { flex-direction:column; }
            .date-filter { flex-direction:column; }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>QUIRINO GENERAL HIGH SCHOOL</h1>
            <h2>QR Attendance System</h2>
            <p>Streamlined student attendance tracking with QR code technology</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab(event,'students')">ðŸ‘¥ Students</button>
            <button class="nav-tab" onclick="showTab(event,'scanner')">ðŸ“· Scanner</button>
            <button class="nav-tab" onclick="showTab(event,'attendance')">ðŸ“Š Attendance</button>
            <button class="nav-tab" onclick="showTab(event,'reports')">ðŸ“ˆ Reports</button>
            <button class="nav-tab" onclick="showTab(event,'export')">ðŸ’¾ Export</button>
        </div>

        <!-- Students Tab -->
        <div id="students" class="tab-content active">
            <h2>Student Management</h2>

            <div class="form-row">
                <div class="form-group">
                    <label for="studentName">Student Name</label>
                    <input type="text" id="studentName" placeholder="Enter student name">
                </div>
                <div class="form-group">
                    <label for="studentId">Student ID (LRN or ID)</label>
                    <input type="text" id="studentId" placeholder="Enter student ID">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="studentEmail">Email</label>
                    <input type="email" id="studentEmail" placeholder="student@email.com">
                </div>
                <div class="form-group">
                    <label for="studentClass">Class/Section</label>
                    <input type="text" id="studentClass" placeholder="Enter class or section">
                </div>
            </div>

            <button class="btn" onclick="addStudent()">Add Student</button>

            <div id="studentsList" class="student-list"></div>
        </div>

        <!-- Scanner Tab -->
        <div id="scanner" class="tab-content">
            <h2>QR Code Scanner</h2>

            <div class="scanner-container">
                <div class="form-group">
                    <label for="sectionName">Grade/Section</label>
                    <input type="text" id="sectionName" placeholder="e.g., Math Class - Monday">
                </div>

                <div style="margin:12px 0;">
                    <button class="btn" onclick="startScanner()" id="startScanBtn">Start Scanner</button>
                    <button class="btn btn-danger" onclick="stopScanner()" id="stopScanBtn" style="display: none;">Stop Scanner</button>
                </div>

                <div id="qr-reader" style="display: none; margin: 10px 0;"></div>
                <div id="scanResult"></div>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendance" class="tab-content">
            <h2>Attendance Records</h2>

            <div class="date-filter">
                <div class="form-group">
                    <label for="filterDate">Filter by Date</label>
                    <input type="date" id="filterDate">
                </div>
                <div class="form-group">
                    <label for="filterSection">Filter by Section</label>
                    <select id="filterSection">
                        <option value="">All Sections</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="filterAttendance()">Apply Filter</button>
                <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
            </div>

            <div id="attendanceTable"></div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <h2>Attendance Reports</h2>

            <div class="stats-grid" id="statsGrid"></div>

            <h3>Individual Student Reports</h3>
            <div id="individualReports"></div>
        </div>

        <!-- Export Tab -->
        <div id="export" class="tab-content">
            <h2>Export Data</h2>

            <p>Export your attendance data to Excel format for further analysis or record keeping.</p>

            <div class="form-row" style="margin-bottom:15px;">
                <button class="btn" onclick="exportToExcel()">ðŸ“Š Export Attendance to Excel</button>
                <button class="btn btn-secondary" onclick="exportStudents()">ðŸ‘¥ Export Student List</button>
            </div>

            <div class="form-group">
                <label for="importFile">Import Student Data (Excel/CSV) â€” first sheet must have columns: Student Name, Student ID, Email, Class</label>
                <input type="file" id="importFile" accept=".xlsx,.xls,.csv" onchange="importStudentData(event)">
            </div>
        </div>
    </div>

    <!-- optional decorative images -->
    <div><img src="ffe218c6-afd0-4996-b1c3-2726f4d61824-removebg-preview.png" alt="DepEd" style="position:absolute; top:45px; left:250px; width:120px;"></div>
    <div><img src="514941183_2004950386916168_8894779031226690441_n.png" alt="DepEd" style="position:absolute; top:45px; right:250px; width:120px;"></div>

<script>
    // ============================
    // GLOBAL STATE & PERSISTENCE
    // ============================
    let students = [];
    let attendanceRecords = [];
    let html5QrcodeScanner = null;
    let currentSection = '';

    // Use localStorage keys that won't conflict with other storage
    const STUDENTS_KEY = 'qghs_students';
    const ATTENDANCE_KEY = 'qghs_attendance';

    // Load on init
    function init() {
        loadData();
        updateStudentsList();
        updateAttendanceTable();
        updateReports();
        populateSectionFilter();
        // ensure the Students tab is active on load
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById('students').classList.add('active');
        document.querySelectorAll('.nav-tab').forEach(n => n.classList.remove('active'));
        document.querySelector('.nav-tab').classList.add('active');
    }

    function saveData() {
        localStorage.setItem(STUDENTS_KEY, JSON.stringify(students));
        localStorage.setItem(ATTENDANCE_KEY, JSON.stringify(attendanceRecords));
    }

    function loadData() {
        try {
            students = JSON.parse(localStorage.getItem(STUDENTS_KEY)) || [];
            attendanceRecords = JSON.parse(localStorage.getItem(ATTENDANCE_KEY)) || [];
        } catch (e) {
            students = [];
            attendanceRecords = [];
        }
    }

    // ============================
    // TABS
    // ============================
    function showTab(evt, tabName) {
        // hide all
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

        // show the requested
        const el = document.getElementById(tabName);
        if (el) el.classList.add('active');
        if (evt && evt.currentTarget) evt.currentTarget.classList.add('active');

        // update views when switching
        if (tabName === 'students') updateStudentsList();
        if (tabName === 'attendance') updateAttendanceTable();
        if (tabName === 'reports') updateReports();
        if (tabName === 'export') populateSectionFilter();
    }

    // ============================
    // STUDENT MANAGEMENT
    // ============================
    function addStudent() {
        const name = document.getElementById('studentName').value.trim();
        const id = document.getElementById('studentId').value.trim();
        const email = document.getElementById('studentEmail').value.trim();
        const studentClass = document.getElementById('studentClass').value.trim();

        if (!name || !id) {
            showMessage('Please enter both student name and ID', 'error');
            return;
        }
        if (students.find(s => s.id === id)) {
            showMessage('Student ID already exists', 'error');
            return;
        }

        const student = { name, id, email, class: studentClass, qrCode: generateQRData(id) };
        students.push(student);
        saveData();
        updateStudentsList();
        populateSectionFilter();

        // clear form
        document.getElementById('studentName').value = '';
        document.getElementById('studentId').value = '';
        document.getElementById('studentEmail').value = '';
        document.getElementById('studentClass').value = '';

        showMessage('Student added successfully!', 'success');
    }

    function removeStudent(studentId) {
        if (!confirm('Are you sure you want to remove this student?')) return;
        students = students.filter(s => s.id !== studentId);
        attendanceRecords = attendanceRecords.filter(r => r.studentId !== studentId);
        saveData();
        updateStudentsList();
        updateAttendanceTable();
        updateReports();
        populateSectionFilter();
        showMessage('Student removed successfully!', 'success');
    }

    function generateQRData(studentId) {
        // Keep generator consistent with original: embed studentId only.
        return JSON.stringify({ studentId });
    }

    function updateStudentsList() {
        const container = document.getElementById('studentsList');
        container.innerHTML = '';

        if (!students.length) {
            container.innerHTML = '<p>No students registered yet.</p>';
            return;
        }

        students.forEach(student => {
            const card = document.createElement('div');
            card.className = 'student-card';

            // student info
            const info = document.createElement('div');
            info.className = 'student-info';
            info.innerHTML = `
                <h3>${escapeHtml(student.name)}</h3>
                <p><strong>ID:</strong> ${escapeHtml(student.id)}</p>
                <p><strong>Email:</strong> ${escapeHtml(student.email || 'N/A')}</p>
                <p><strong>Class:</strong> ${escapeHtml(student.class || 'N/A')}</p>
            `;

            // create QR code area
            const qrWrap = document.createElement('div');
            qrWrap.className = 'qr-code-container';
            const qrDiv = document.createElement('div');
            // render QR code using qrcodejs library (like original)
            try {
                new QRCode(qrDiv, {
                    text: student.qrCode,
                    width: 150,
                    height: 150,
                    correctLevel: QRCode.CorrectLevel.H
                });
            } catch (err) {
                // In case QR library behaves differently, fallback to text
                qrDiv.textContent = student.qrCode;
            }
            qrWrap.appendChild(qrDiv);

            // remove button
            const actions = document.createElement('div');
            actions.style.marginLeft = 'auto';
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-danger';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = () => removeStudent(student.id);
            actions.appendChild(removeBtn);

            // assemble card (preserve layout)
            card.appendChild(qrWrap);
            card.appendChild(info);
            card.appendChild(actions);
            container.appendChild(card);
        });
    }

    // ============================
    // SCANNER
    // ============================
    function startScanner() {
        const sectionName = document.getElementById('sectionName').value.trim();
        if (!sectionName) {
            showMessage('Please enter a section name', 'error');
            return;
        }
        currentSection = sectionName;

        document.getElementById('qr-reader').style.display = 'block';
        document.getElementById('startScanBtn').style.display = 'none';
        document.getElementById('stopScanBtn').style.display = 'inline-block';

        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear().catch(() => {}).finally(() => html5QrcodeScanner = null);
        }

        // Use Html5QrcodeScanner (kept same as original)
        html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
        }, false);

        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    }

    function stopScanner() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear().then(() => {
                html5QrcodeScanner = null;
                document.getElementById('qr-reader').style.display = 'none';
                document.getElementById('startScanBtn').style.display = 'inline-block';
                document.getElementById('stopScanBtn').style.display = 'none';
                document.getElementById('scanResult').innerHTML = '';
            }).catch(err => {
                console.error('Failed to stop scanner', err);
            });
        } else {
            document.getElementById('qr-reader').style.display = 'none';
            document.getElementById('startScanBtn').style.display = 'inline-block';
            document.getElementById('stopScanBtn').style.display = 'none';
            document.getElementById('scanResult').innerHTML = '';
        }
    }

    // IMPORTANT: Replaced onScanSuccess to support Time In / Time Out behavior
    function onScanSuccess(decodedText, decodedResult) {
        // Expecting decodedText to be JSON: {"studentId":"..."}
        try {
            const qrData = JSON.parse(decodedText);
            const studentId = qrData.studentId;
            const student = students.find(s => s.id === studentId);
            if (!student) {
                showScanResult('Student not found in database', 'error');
                return;
            }

            // Determine today's date string (local)
            const todayStr = new Date().toDateString();

            // Try to find an existing attendance record for this student in this section today
            let existing = attendanceRecords.find(r =>
                r.studentId === studentId &&
                r.section === currentSection &&
                new Date(r.date).toDateString() === todayStr
            );

            if (!existing) {
                // No record yet today for this section â†’ create new record with timeIn
                const rec = {
                    studentId: studentId,
                    studentName: student.name,
                    section: currentSection,
                    date: new Date().toISOString(), // store ISO date for sorting/filtering
                    timeIn: new Date().toLocaleTimeString(), // human-readable time
                    timeOut: null,
                    // keep status for compatibility (optional)
                    status: 'Present'
                };
                attendanceRecords.push(rec);
                saveData();
                updateAttendanceTable();
                updateReports();
                populateSectionFilter();
                showScanResult(`âœ… ${student.name} Time In recorded!`, 'success');
                return;
            }

            // If record exists and timeOut is not set â†’ set timeOut
            if (existing && !existing.timeOut) {
                existing.timeOut = new Date().toLocaleTimeString();
                // optionally update status
                existing.status = 'Present';
                saveData();
                updateAttendanceTable();
                updateReports();
                showScanResult(`âœ… ${student.name} Time Out recorded!`, 'success');
                return;
            }

            // If record exists and both are set, inform user
            if (existing && existing.timeOut) {
                showScanResult(`${student.name} already has Time In & Time Out for this section today`, 'error');
                return;
            }

        } catch (err) {
            console.error('scan parse error', err);
            showScanResult('Invalid QR code format', 'error');
        }
    }

    function onScanFailure(error) {
        // silent; don't spam UI
        // console.debug('scan failure', error);
    }

    function showScanResult(message, type) {
        const resultDiv = document.getElementById('scanResult');
        resultDiv.className = type === 'success' ? 'success-message' : 'error-message';
        resultDiv.innerHTML = message;
        setTimeout(() => {
            // remove message but keep element
            resultDiv.innerHTML = '';
            resultDiv.className = '';
        }, 3500);
    }

    // ============================
    // ATTENDANCE TABLE / FILTERS
    // ============================

    function updateAttendanceTable() {
        const container = document.getElementById('attendanceTable');
        if (!attendanceRecords || attendanceRecords.length === 0) {
            container.innerHTML = '<p>No attendance records found.</p>';
            return;
        }

        // Apply filters if any
        let filtered = [...attendanceRecords];
        const filterDate = document.getElementById('filterDate')?.value;
        if (filterDate) {
            filtered = filtered.filter(r => new Date(r.date).toDateString() === new Date(filterDate).toDateString());
        }
        const filterSection = document.getElementById('filterSection')?.value;
        if (filterSection) {
            filtered = filtered.filter(r => r.section === filterSection);
        }

        // Sort newest first
        filtered.sort((a,b) => new Date(b.date) - new Date(a.date));

        // Build table with Date, Time In, Time Out columns (as requested)
        const table = document.createElement('table');
        table.className = 'attendance-table';
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Student ID</th>
                    <th>Section</th>
                    <th>Date</th>
                    <th>Time In</th>
                    <th>Time Out</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                ${filtered.map(r => `
                    <tr>
                        <td>${escapeHtml(r.studentName)}</td>
                        <td>${escapeHtml(r.studentId)}</td>
                        <td>${escapeHtml(r.section)}</td>
                        <td>${new Date(r.date).toLocaleDateString()}</td>
                        <td>${r.timeIn || '-'}</td>
                        <td>${r.timeOut || '-'}</td>
                        <td class="${r.status === 'Present' ? 'status-present' : 'status-absent'}">${escapeHtml(r.status || '')}</td>
                    </tr>
                `).join('')}
            </tbody>
        `;
        container.innerHTML = '';
        container.appendChild(table);
    }

    function filterAttendance() {
        updateAttendanceTable();
    }

    function clearFilters() {
        document.getElementById('filterDate').value = '';
        document.getElementById('filterSection').value = '';
        updateAttendanceTable();
    }

    // ============================
    // REPORTS
    // ============================
    function updateReports() {
        updateStats();
        updateIndividualReports();
    }

    function updateStats() {
        const container = document.getElementById('statsGrid');
        const totalStudents = students.length;
        const sections = new Set(attendanceRecords.map(r => r.section));
        const totalSections = sections.size;
        const todayAttendance = attendanceRecords.filter(r => new Date(r.date).toDateString() === new Date().toDateString()).length;
        const avgAttendance = (totalSections > 0 && totalStudents > 0) ? Math.round((attendanceRecords.length / (totalStudents * totalSections)) * 100) : 0;

        container.innerHTML = `
            <div class="stat-card">
                <div class="stat-number">${totalStudents}</div>
                <div class="stat-label">Total Students</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${totalSections}</div>
                <div class="stat-label">Total Sections</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${todayAttendance}</div>
                <div class="stat-label">Today's Attendance</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${avgAttendance}%</div>
                <div class="stat-label">Average Attendance</div>
            </div>
        `;
    }

    function updateIndividualReports() {
        const container = document.getElementById('individualReports');
        if (students.length === 0) {
            container.innerHTML = '<p>No students registered yet.</p>';
            return;
        }

        const totalSections = new Set(attendanceRecords.map(r => r.section)).size;
        const studentStats = students.map(s => {
            const recs = attendanceRecords.filter(r => r.studentId === s.id);
            const attendanceRate = totalSections > 0 ? Math.round((recs.length / totalSections) * 100) : 0;
            return { ...s, totalAttendance: recs.length, attendanceRate };
        });

        const table = document.createElement('table');
        table.className = 'attendance-table';
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Student ID</th>
                    <th>Total Attendance</th>
                    <th>Attendance Rate</th>
                </tr>
            </thead>
            <tbody>
                ${studentStats.map(s => `
                    <tr>
                        <td>${escapeHtml(s.name)}</td>
                        <td>${escapeHtml(s.id)}</td>
                        <td>${s.totalAttendance}</td>
                        <td>${s.attendanceRate}%</td>
                    </tr>
                `).join('')}
            </tbody>
        `;
        container.innerHTML = '';
        container.appendChild(table);
    }

    // ============================
    // SECTION FILTER POPULATION
    // ============================
    function populateSectionFilter() {
        const select = document.getElementById('filterSection');
        // gather sections from attendance records and student classes
        const sections = Array.from(new Set(attendanceRecords.map(r => r.section).concat(students.map(s => s.class || '').filter(Boolean))));
        select.innerHTML = '<option value="">All Sections</option>';
        sections.forEach(sec => {
            const opt = document.createElement('option');
            opt.value = sec;
            opt.textContent = sec;
            select.appendChild(opt);
        });
    }

    // ============================
    // IMPORT / EXPORT
    // ============================
    function exportToExcel() {
        const wb = XLSX.utils.book_new();

        // Attendance sheet: include Time In & Time Out
        const attendanceData = attendanceRecords.map(r => ({
            'Student Name': r.studentName,
            'Student ID': r.studentId,
            'Section': r.section,
            'Date': new Date(r.date).toLocaleDateString(),
            'Time In': r.timeIn || '',
            'Time Out': r.timeOut || '',
            'Status': r.status || ''
        }));
        const attendanceWS = XLSX.utils.json_to_sheet(attendanceData);
        XLSX.utils.book_append_sheet(wb, attendanceWS, 'Attendance Records');

        // Students sheet
        const studentsData = students.map(s => ({
            'Student Name': s.name,
            'Student ID': s.id,
            'Email': s.email || '',
            'Class': s.class || ''
        }));
        const studentsWS = XLSX.utils.json_to_sheet(studentsData);
        XLSX.utils.book_append_sheet(wb, studentsWS, 'Students');

        XLSX.writeFile(wb, `Attendance_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
        showMessage('Excel file exported successfully!', 'success');
    }

    function exportStudents() {
        const wb = XLSX.utils.book_new();
        const studentsData = students.map(s => ({
            'Student Name': s.name,
            'Student ID': s.id,
            'Email': s.email || '',
            'Class': s.class || ''
        }));
        const ws = XLSX.utils.json_to_sheet(studentsData);
        XLSX.utils.book_append_sheet(wb, ws, 'Students');
        XLSX.writeFile(wb, `Students_List_${new Date().toISOString().slice(0,10)}.xlsx`);
        showMessage('Student list exported successfully!', 'success');
    }

    function importStudentData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                let imported = 0;
                jsonData.forEach(row => {
                    const name = row['Student Name'] || row['Name'];
                    const id = row['Student ID'] || row['ID'];
                    const email = row['Email'] || '';
                    const cls = row['Class'] || row['Section'] || '';
                    if (name && id && !students.find(s => s.id === id)) {
                        students.push({ name, id, email, class: cls, qrCode: generateQRData(id) });
                        imported++;
                    }
                });
                saveData();
                updateStudentsList();
                populateSectionFilter();
                showMessage(`Imported ${imported} students.`, 'success');
            } catch (err) {
                console.error(err);
                showMessage('Error importing file. Check format.', 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // ============================
    // UTILITIES
    // ============================
    function showMessage(message, type) {
        const active = document.querySelector('.tab-content.active') || document.getElementById('students');
        if (!active) return;
        const msg = document.createElement('div');
        msg.className = type === 'success' ? 'success-message' : 'error-message';
        msg.innerHTML = message;
        active.insertBefore(msg, active.firstChild);
        setTimeout(() => msg.remove(), 4500);
    }

    function escapeHtml(str) {
        if (!str && str !== 0) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    // Initialize once page loads
    window.addEventListener('load', init);

    // End of script
</script>
</body>
</html>